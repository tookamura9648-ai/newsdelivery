<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>手描きルート作成（Leaflet + Geoman）</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<!-- Leaflet-Geoman Free（手描き・編集UI） -->
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.css">
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.1/dist/leaflet-geoman.min.js"></script>

<!-- 簡略化（任意） -->
<script src="https://unpkg.com/simplify-js@1.2.4/simplify.min.js"></script>

<style>
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Meiryo,sans-serif}
  #map{height:100vh}
  .panel{
    position:fixed;left:12px;top:12px;z-index:1000;background:#fff;
    border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.15);
    padding:10px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap
  }
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
  button,input{padding:6px 10px}
  /* Geomanのハンドルと被らないように */
  .panel.pm-ignore { pointer-events:auto }
</style>
</head>
<body>
<div id="map"></div>

<div class="panel pm-ignore">
  <button id="draw">新規ルート</button>
  <button id="finish" disabled>描画完了</button>
  <button id="clear" disabled>クリア</button>
  <span>|</span>
  簡略化[m]: <input id="tol" type="number" value="10" min="0" step="1" style="width:6em">
  <button id="simplify" disabled>適用</button>
  <span>|</span>
  <button id="saveGeo">GeoJSON保存</button>
  <button id="saveGpx">GPX保存</button>
  <span class="mono" id="len">距離: 0 m</span>
</div>

<script>
const map = L.map('map').setView([35.0045,135.8686], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  {maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

// ★ Geomanのツールバー（必要なものだけ）
map.pm.addControls({
  position: 'topleft',
  drawCircle: false, drawRectangle: false, drawMarker: false, drawCircleMarker: false, drawText: false,
  drawPolygon: false, drawPolyline: false, // ←最初は自前ボタンで開始
  editMode: true, dragMode: false, cutPolygon: false, removalMode: true, rotateMode: false
});

let routeLayer = null; // 描いたポリライン用

// 便利関数
const rad = x=>x*Math.PI/180;
function haversine(a,b){
  const R=6371000, dLat=rad(b.lat-a.lat), dLng=rad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const aa=s1*s1 + Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(aa)));
}
function pathLength(latlngs){
  let d=0; for(let i=1;i<latlngs.length;i++) d+=haversine(latlngs[i-1], latlngs[i]);
  return d; // meters
}
function updateLength(){
  const ll = routeLayer?.getLatLngs() ?? [];
  const d = ll.length>=2 ? pathLength(ll) : 0;
  document.getElementById('len').textContent = `距離: ${d.toFixed(1)} m`;
}
function download(name, text, type){
  const blob = new Blob([text], {type}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
}

// 描画開始
document.getElementById('draw').onclick = ()=>{
  // 既存ルートがあれば編集モードにするか、消すか選択
  if (routeLayer) {
    map.pm.enableGlobalEditMode(); // 既存の頂点を編集
    return;
  }
  map.pm.enableDraw('Line', { templineStyle:{color:'#0aa'}, hintlineStyle:{color:'#0aa'},
    pathOptions:{color:'#0aa', weight:5} });
  document.getElementById('finish').disabled = false;
};

// 描画完了（グローバルドローを終了）
document.getElementById('finish').onclick = ()=>{
  map.pm.disableDraw('Line');
  document.getElementById('finish').disabled = true;
};

// Geomanの作成イベント：線が出来たら確定
map.on('pm:create', e=>{
  if (e.layer instanceof L.Polyline){
    if (routeLayer) routeLayer.remove();
    routeLayer = e.layer;
    map.fitBounds(routeLayer.getBounds(), {padding:[20,20]});
    document.getElementById('clear').disabled = false;
    document.getElementById('simplify').disabled = false;
    updateLength();
    // 編集中の長さも更新
    routeLayer.on('pm:edit', updateLength);
    routeLayer.on('pm:vertexadded', updateLength);
    routeLayer.on('pm:vertexremoved', updateLength);
    routeLayer.on('pm:markerdragend', updateLength);
  }
});

// クリア
document.getElementById('clear').onclick = ()=>{
  if (routeLayer){ routeLayer.remove(); routeLayer=null; }
  document.getElementById('clear').disabled = true;
  document.getElementById('simplify').disabled = true;
  document.getElementById('finish').disabled = true;
  document.getElementById('len').textContent = '距離: 0 m';
};

// 簡略化（Douglas–Peucker）: tol[m]
document.getElementById('simplify').onclick = ()=>{
  if (!routeLayer) return;
  const tol = Math.max(0, +document.getElementById('tol').value || 0);
  if (tol<=0){ updateLength(); return; }
  const latlngs = routeLayer.getLatLngs();
  if (latlngs.length<3) return;

  // 実座標(m)に変換して簡略化→緯度経度へ戻す
  const avgLat = latlngs.reduce((s,p)=>s+p.lat,0)/latlngs.length;
  const mPerDegLat = 111_132;
  const mPerDegLng = 111_320 * Math.cos(avgLat * Math.PI/180);
  const pts = latlngs.map(p=>({x:p.lng*mPerDegLng, y:p.lat*mPerDegLat}));
  const simp = window.simplify(pts, tol, true);
  const latlngs2 = simp.map(p=>L.latLng(p.y/mPerDegLat, p.x/mPerDegLng));
  routeLayer.setLatLngs(latlngs2);
  updateLength();
};

// 保存（GeoJSON/GPX）
document.getElementById('saveGeo').onclick = ()=>{
  const ll = routeLayer?.getLatLngs(); if (!ll?.length) { alert('ルートがありません'); return; }
  const gj = {
    type:'FeatureCollection',
    features:[{
      type:'Feature',
      properties:{ name:'hand-drawn' },
      geometry:{ type:'LineString', coordinates: ll.map(p=>[p.lng, p.lat]) }
    }]
  };
  download('official-route.geojson', JSON.stringify(gj), 'application/geo+json');
};
document.getElementById('saveGpx').onclick = ()=>{
  const ll = routeLayer?.getLatLngs(); if (!ll?.length) { alert('ルートがありません'); return; }
  const trkpts = ll.map(p=>`<trkpt lat="${p.lat}" lon="${p.lng}"></trkpt>`).join('');
  const gpx =
`<?xml version="1.0" encoding="UTF-8"?>
<gpx creator="route-draw" version="1.1" xmlns="http://www.topografix.com/GPX/1/1">
  <trk><name>hand-drawn</name><trkseg>${trkpts}</trkseg></trk>
</gpx>`;
  download('hand-drawn.gpx', gpx, 'application/gpx+xml');
};

// スマホ操作のこつ：長押しで頂点ドラッグ、ダブルタップで確定など
</script>
</body>
</html>
