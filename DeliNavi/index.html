<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>DeliNavi</title>

  <!-- 404é˜²æ­¢: è¶…è»½é‡faviconï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ï¼‰ -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3EğŸ—ºï¸%3C/text%3E%3C/svg%3E">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- å›è»¢ãƒãƒ¼ã‚«ãƒ¼ -->
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>
  <!-- CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- QRç”Ÿæˆ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    html,body,#map{height:100%;margin:0}
    body{background:#000;overscroll-behavior:none}
    #map{position:fixed;inset:0}

    .panel{
      position:absolute;z-index:1000;left:10px;top:10px;background:#fff;
      padding:10px 12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.15);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",Meiryo,sans-serif
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
    .btn{padding:6px 10px;border:1px solid #ccc;border-radius:8px;background:#f6f6f6;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .badge{background:#111;color:#fff;border-radius:10px;padding:3px 8px;font-weight:700}
    .small{font-size:12px;color:#666}

    /* QRãƒ¢ãƒ¼ãƒ€ãƒ« */
    #qrModal{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
    #qrModal > div{background:#fff;padding:16px 18px;border-radius:12px;text-align:center}
  </style>
</head>
<body>
  <div id="map" aria-label="map"></div>

  <!-- UI -->
  <div class="panel">
    <div class="row">
      <span class="badge" id="counter">#0 / 0</span>
      <button class="btn" id="btnFit">å…¨ä½“è¡¨ç¤º</button>
      <button class="btn" id="btnPrev" disabled>â—€ å‰</button>
      <button class="btn" id="btnNext" disabled>æ¬¡ â–¶</button>
      <button class="btn" id="btnQR">QRå…±æœ‰</button>
    </div>
    <div class="row">
      <button class="btn" id="btnGPS">GPSé–‹å§‹</button>
      <button class="btn" id="btnStop" disabled>åœæ­¢</button>
      <label class="small">åˆ°ç€åŠå¾„ <input type="number" id="radius" value="50" style="width:4.5em"> m</label>
    </div>
    <div class="row">
      <label class="small"><input type="checkbox" id="chkFollow" checked> ä¸­å¤®å›ºå®šï¼ˆè¿½å¾“ï¼‰</label>
      <label class="small"><input type="checkbox" id="chkHeading" checked> çŸ¢å°ï¼é€²è¡Œæ–¹å‘</label>
    </div>
    <div class="small" id="status">åˆæœŸåŒ–ä¸­â€¦</div>
  </div>

  <!-- QRãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="qrModal">
    <div>
      <canvas id="qrCanvas" width="260" height="260"></canvas><br>
      <div style="margin-top:8px;font-size:12px" id="qrUrl"></div>
      <button class="btn" id="qrClose" style="margin-top:10px">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ï¼ˆåœ°å›³ãƒ»CSVãƒ»GPSï¼‰ -->
  <script>
  (function whenReady(fn){
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, {once:true});
    else fn();
  })(function initApp(){

    // ====== è¨­å®š ======
    const CSV_URL = './assets/data/points.csv'; // åˆ—: name,address,note,lat,lngï¼ˆâ€»åˆ—åã¯destLabelå´ã§ãƒãƒƒãƒ”ãƒ³ã‚°å¯ï¼‰
    const OFFICIAL_ROUTE_URL = './assets/routes/official-route.geojson';
    const SHOW_PLANNED_LINE = false; // é’ã®ç ´ç·šï¼ˆCSVé †ã®äºˆå®šç·šï¼‰
    const AUTO_ADVANCE = false;      // åˆ°ç€ã§è‡ªå‹•ã§é€²ã‚ãªã„ï¼ˆãƒ†ã‚¹ãƒˆé‹ç”¨ï¼‰

    // ====== åœ°å›³ ======
    const map = L.map('map', {zoomControl:true, preferCanvas:true}).setView([35.0,135.87], 13);
    window.__DN_map = map; // Assistãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç”¨ã«å…¬é–‹
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    // ====== å…¬å¼ãƒ«ãƒ¼ãƒˆ ======
    const officialRouteGroup = L.featureGroup().addTo(map);
    let officialSegments = [];   // [[latlng...], ...]
    let officialRouteFlat = [];  // latlng[]ï¼ˆé€£çµï¼‰
    let legHighlight = null;

    // ====== ç›®çš„åœ°ï¼ˆCSVç”±æ¥ï¼‰ãƒ»ãƒãƒ¼ã‚«ãƒ¼ ======
    // æ³¨æ„ï¼šCSVã¯â€œè¡Œã‚’é£›ã°ã•ãšâ€é…åˆ—ã«å…¥ã‚Œã‚‹ã€‚ãƒ”ãƒ³ã¯åº§æ¨™ãŒã‚ã‚‹è¡Œã ã‘ä½œã‚‹ã€‚
    let csvRows = [];            // å…¨è¡Œï¼ˆåº§æ¨™ãŒç„¡ãã¦ã‚‚ä¿æŒï¼‰
    let destMarkers = [];        // Leafletãƒãƒ¼ã‚«ãƒ¼é…åˆ—ï¼ˆåº§æ¨™ã‚ã‚‹è¡Œã®ã¿ï¼‰
    let plannedLayer = null;

    // ====== å®Ÿèµ°ãƒ­ã‚° ======
    const liveTrack = L.polyline([], {color:'#222', weight:3}).addTo(map);

    // ====== è‡ªä½ç½®ãƒãƒ¼ã‚«ãƒ¼ ======
    const userIcon = L.icon({
      iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
           <defs><filter id="s"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.4"/></filter></defs>
           <g filter="url(#s)">
             <circle cx="32" cy="32" r="9" fill="#fff"/>
             <polygon points="32,6 44,34 32,28 20,34" fill="#007aff"/>
           </g>
         </svg>`),
      iconSize:[44,44], iconAnchor:[22,22]
    });
    let userMarker = null, userAccCircle = null;
    let followMode = true, rotateToHeading = true;
    let lastLatLng = null, lastHeading = 0;

    // ====== çŠ¶æ…‹UI ======
    const $ = sel => document.querySelector(sel);
    const setStatus = t => $('#status').textContent = t;

    // ====== ãƒœã‚¿ãƒ³é…ç·šï¼ˆÂ±1ã«æ­£è¦åŒ–ï¼‰ ======
    const prevBtn = $('#btnPrev');
    const nextBtn = $('#btnNext');
    prevBtn?.addEventListener('click', e => { e.preventDefault(); stepCSV(-1); });
    nextBtn?.addEventListener('click', e => { e.preventDefault(); stepCSV(+1); });

    $('#btnFit').addEventListener('click', fitAll);
    $('#btnGPS').addEventListener('click', startGPS);
    $('#btnStop').addEventListener('click', stopGPS);
    $('#btnQR').addEventListener('click', showQR);
    $('#qrClose').addEventListener('click', ()=>{ $('#qrModal').style.display='none'; });

    $('#chkFollow').addEventListener('change', e=>{
      followMode = e.target.checked;
      if (followMode && lastLatLng) map.setView(lastLatLng, map.getZoom(), {animate:false});
    });
    $('#chkHeading').addEventListener('change', e=>{
      rotateToHeading = e.target.checked;
      if (userMarker?.setRotationAngle) userMarker.setRotationAngle(rotateToHeading ? lastHeading : 0);
    });

    // ====== åˆæœŸãƒ­ãƒ¼ãƒ‰ ======
    Promise.all([loadOfficialRoute(), loadCSV()])
      .then(()=>{
        setStatus('æº–å‚™OKã€‚GPSé–‹å§‹ã§ã‚¹ã‚¿ãƒ¼ãƒˆ');
        fitAll();
      })
      .catch(err=>{ console.error(err); setStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message); });

    // ====== CSV èª­ã¿è¾¼ã¿ï¼ˆè¡Œã¯é£›ã°ã•ãªã„ï¼‰ ======
    async function loadCSV(){
      const res = await fetch(CSV_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('points.csv not found');
      const text = await res.text();
      const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});

      // å…¨è¡Œä¿æŒï¼ˆåº§æ¨™ã¯NaNã®ã¾ã¾ã§ã‚‚OKï¼‰
      csvRows = parsed.data.map(r=>({
        name: (r.name ?? r.æ°å ?? r.ãŠåå‰ ?? r.label ?? '').trim(),
        address: (r.address ?? r.ä½æ‰€ ?? r.æ‰€åœ¨åœ° ?? '').trim(),
        note: (r.note ?? r.å‚™è€ƒ ?? r.ãƒ¡ãƒ¢ ?? r.åŒºåˆ† ?? '').trim(),
        lat: parseFloat(r.lat ?? r.latitude ?? r.ç·¯åº¦),
        lng: parseFloat(r.lng ?? r.longitude ?? r.çµŒåº¦)
      }));

      // ç›®çš„åœ°ãƒ”ãƒ³ã¯ã€Œåº§æ¨™ãŒã‚ã‚‹è¡Œã ã‘ã€ä½œã‚‹
      destMarkers.forEach(m=>map.removeLayer(m)); destMarkers = [];
      if (plannedLayer){ map.removeLayer(plannedLayer); plannedLayer=null; }

      csvRows.forEach((d,i)=>{
        if (Number.isFinite(d.lat) && Number.isFinite(d.lng)) {
          const m = L.marker([d.lat,d.lng]).addTo(map)
            .bindTooltip(String(i+1), {permanent:true, direction:'top'});
          destMarkers.push(m);
        }
      });

      // Assistã«ç™»éŒ² â†’ â‘ ã ã‘è¡¨ç¤º
      window.DN_registerDestinationMarkers && window.DN_registerDestinationMarkers(destMarkers, map);
      window.DN_setMarkerMode && window.DN_setMarkerMode('next'); // èµ·å‹•æ™‚ã¯æ¬¡ã ã‘ï¼ˆ=â‘ ã ã‘ï¼‰

      if (SHOW_PLANNED_LINE) {
        const line = csvRows.filter(d=>Number.isFinite(d.lat)&&Number.isFinite(d.lng))
                            .map(d=>[d.lat,d.lng]);
        plannedLayer = L.polyline(line, { color:'#1e6bff', weight:3, dashArray:'6 6' }).addTo(map);
      }

      // ã‚«ã‚¦ãƒ³ã‚¿åˆæœŸåŒ–ï¼ˆdestLabelãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…ã£ã¦ã‹ã‚‰æ›´æ–°ï¼‰
      setTimeout(()=>refreshCounterAndHighlight(), 0);
    }

    // ====== ã‚«ã‚¦ãƒ³ã‚¿ã¨åŒºé–“ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆCSVåŸºæº–ï¼‰ ======
    let lastRec = null; // ç›´å‰è¡¨ç¤ºã—ã¦ã„ãŸãƒ©ãƒ™ãƒ«ã®è¡Œ
    function stepCSV(delta){
      const move = window.DN_destLabelMove;
      const curr = window.DN_destLabelCurrent?.() || null;
      if (curr) lastRec = curr; // å‰ã®è¡Œã‚’ä¿æŒ

      const rec = move ? move(delta) : null; // è¡¨ç¤ºè¡Œã‚’Â±1
      if (rec && Number.isFinite(rec.lat) && Number.isFinite(rec.lng)) {
        map.panTo([rec.lat, rec.lng]);
      }
      refreshCounterAndHighlight(rec, lastRec);
    }
    function refreshCounterAndHighlight(nowRec = window.DN_destLabelCurrent?.(), prevRec = lastRec){
      const idx   = window.DN_destLabelIndex?.() ?? 0;
      const total = window.DN_destLabelCount?.() ?? csvRows.length;
      $('#counter').textContent = `#${total ? idx+1 : 0} / ${total}`;
      $('#btnPrev').disabled = (idx <= 0);
      $('#btnNext').disabled = (idx >= total-1);

      updateLegHighlight(prevRec, nowRec);
    }

    // ====== å…¬å¼ãƒ«ãƒ¼ãƒˆï¼ˆMultiLine / FeatureCollection å¯¾å¿œï¼‰ ======
    async function loadOfficialRoute(){
      const res = await fetch(OFFICIAL_ROUTE_URL + '?v=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('official-route.geojson not found');
      const gj = await res.json();

      officialRouteGroup.clearLayers();
      officialSegments = [];
      officialRouteFlat = [];

      const feats = (gj.type==='FeatureCollection') ? (gj.features||[]) : [gj];
      feats.forEach(ft=>{
        if(!ft?.geometry) return;
        const color = (ft.properties?.leg==='back') ? '#ff8c00' : '#00a7a7';
        const segs = [];

        if(ft.geometry.type==='LineString'){
          if(ft.geometry.coordinates?.length>=2) segs.push(ft.geometry.coordinates);
        }else if(ft.geometry.type==='MultiLineString'){
          (ft.geometry.coordinates||[]).forEach(c=>{ if(c?.length>=2) segs.push(c); });
        }

        segs.forEach(coords=>{
          const latlngs = coords.map(([lng,lat])=>[lat,lng]);
          L.polyline(latlngs, {color, weight:5, opacity:.9}).addTo(officialRouteGroup);
          officialSegments.push(latlngs);
          officialRouteFlat.push(...latlngs);
        });
      });
    }

    // ====== è¡¨ç¤ºç¯„å›² ======
    function fitAll(){
      const b = L.latLngBounds([]);
      if(officialRouteGroup.getLayers().length) b.extend(officialRouteGroup.getBounds());
      if(plannedLayer) b.extend(plannedLayer.getBounds());
      if(destMarkers.length) b.extend(L.featureGroup(destMarkers).getBounds());
      if(legHighlight) b.extend(legHighlight.getBounds());
      if(b.isValid()) map.fitBounds(b, {padding:[20,20]});
    }

    // ====== åŒºé–“ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆprevâ†’now ã‚’å…¬å¼ãƒ«ãƒ¼ãƒˆä¸Šã§å¤ªç·šï¼‰ ======
    function nearestIndexOnRoute(pt/* [lat,lng] */){
      if (!officialRouteFlat.length) return 0;
      let best = 0, bestD = Infinity;
      for (let i=0;i<officialRouteFlat.length;i++){
        const d = distanceMeters(pt, officialRouteFlat[i]);
        if (d < bestD){ bestD = d; best = i; }
      }
      return best;
    }
    function updateLegHighlight(prevRec, nowRec){
      // æ—¢å­˜å‰Šé™¤
      if (legHighlight) { map.removeLayer(legHighlight); legHighlight=null; }

      if (!nowRec || !Number.isFinite(nowRec.lat) || !Number.isFinite(nowRec.lng)) return;

      // prev ãŒç„¡ã‘ã‚Œã° now ã®ä¸€ç‚¹ or now ã¾ã§ã®çŸ­ç·š
      let A = null, B = [nowRec.lat, nowRec.lng];
      if (prevRec && Number.isFinite(prevRec.lat) && Number.isFinite(prevRec.lng)) {
        A = [prevRec.lat, prevRec.lng];
      } else {
        A = B;
      }

      if (!officialRouteFlat.length) {
        // å…¬å¼ãƒ«ãƒ¼ãƒˆç„¡ã— â†’ ç›´ç·š
        if (A && B) legHighlight = L.polyline([A,B], {color:'#ff2970', weight:7}).addTo(map);
        return;
      }

      const s = nearestIndexOnRoute(A);
      const e = nearestIndexOnRoute(B);
      const seg = (s<=e) ? officialRouteFlat.slice(s, e+1) : officialRouteFlat.slice(e, s+1).reverse();
      if (seg.length >= 2) {
        legHighlight = L.polyline(seg, { color:'#ff2970', weight:7, opacity:0.9 }).addTo(map);
      }
    }

    // ====== GPS ======
    let watchId = null;
    function startGPS(){
      if(!('geolocation' in navigator)){ setStatus('ã“ã®ç«¯æœ«ã¯GPSéå¯¾å¿œ'); return; }
      $('#btnGPS').disabled = true;
      $('#btnStop').disabled = false;
      setStatus('æ¸¬ä½ä¸­â€¦');
      liveTrack.setLatLngs([]);

      watchId = navigator.geolocation.watchPosition(onPos, onErr, {
        enableHighAccuracy:true, maximumAge:0, timeout:15000
      });
    }
    function stopGPS(){
      if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      $('#btnGPS').disabled = false;
      $('#btnStop').disabled = true;
      setStatus('åœæ­¢ã—ã¾ã—ãŸ');
    }
    function onPos(pos){
      const { latitude:lat, longitude:lng, accuracy, heading:h } = pos.coords;
      const curr = [lat, lng];

      // è‡ªä½ç½®
      if (!userMarker) {
        userMarker = L.marker(curr, { icon:userIcon, rotationAngle:0, rotationOrigin:'center' }).addTo(map);
        userAccCircle = L.circle(curr, { radius: accuracy||0, color:'#2b8', weight:1, fillOpacity:0.07 }).addTo(map);
      } else {
        userMarker.setLatLng(curr);
        userAccCircle?.setLatLng(curr).setRadius(accuracy||0);
      }

      // é€²è¡Œæ–¹å‘
      let hdg = Number.isFinite(h) ? h : (lastLatLng ? bearing(lastLatLng, curr) : lastHeading||0);
      if (rotateToHeading && userMarker.setRotationAngle) userMarker.setRotationAngle(hdg);
      lastHeading = hdg; lastLatLng = curr;

      // è¿½å¾“
      if (followMode) map.setView(curr, map.getZoom(), {animate:false});

      // å®Ÿèµ°ãƒ­ã‚°
      liveTrack.addLatLng(curr);

      // åˆ°ç€åˆ¤å®šï¼ˆè‡ªå‹•å‰é€²ã¯OFFï¼‰
      const rec = window.DN_destLabelCurrent?.();
      if (rec && Number.isFinite(rec.lat) && Number.isFinite(rec.lng)) {
        const d = distanceMeters(curr, [rec.lat, rec.lng]);
        const rr = parseFloat($('#radius').value) || 50;
        setStatus(`ç²¾åº¦Â±${Math.round(accuracy||0)}m / ç›®çš„åœ°ã¾ã§ ${Math.round(d)}m`);
        if (d <= rr) {
          ping();
          showArrive(rec);
          if (AUTO_ADVANCE) stepCSV(+1);
        }
      }
    }
    function onErr(err){ setStatus('GPSã‚¨ãƒ©ãƒ¼: ' + err.message); }

    // ====== é€šçŸ¥ï¼ˆWebAudio + ãƒã‚¤ãƒ–ï¼‰ ======
    let audioCtx = null;
    function ping(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.frequency.value = 880; g.gain.value = 0.0001;
        o.connect(g).connect(audioCtx.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.25);
        o.stop(audioCtx.currentTime+0.26);
      }catch(e){}
      if(navigator.vibrate) navigator.vibrate([200,100,200]);
    }
    function showQR(){
      const url = location.origin + location.pathname + location.search;
      const canvas = document.getElementById('qrCanvas');
      QRCode.toCanvas(canvas, url, { width: 260, margin: 1 }, (err)=>{ if(err) console.error(err); });
      document.getElementById('qrUrl').textContent = url;
      document.getElementById('qrModal').style.display = 'flex';
    }

    // ====== è·é›¢ç³» ======
    function distanceMeters(a,b){
      const toRad = x=>x*Math.PI/180, R=6371000;
      const dLat=toRad(b[0]-a[0]), dLng=toRad(b[1]-a[1]);
      const s1=Math.sin(dLat/2)**2 + Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s1));
    }
    function bearing(a,b){
      const toRad = d=>d*Math.PI/180, toDeg = r=>r*180/Math.PI;
      const Ï†1=toRad(a[0]), Ï†2=toRad(b[0]), Î”Î»=toRad(b[1]-a[1]);
      const y=Math.sin(Î”Î»)*Math.cos(Ï†2);
      const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
      return (toDeg(Math.atan2(y,x))+360)%360;
    }

    // ====== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ======
    function showArrive(d){
      const html = `<div><strong>åˆ°ç€:</strong> ${d.name||''}<br>
        ç·¯åº¦:${Number.isFinite(d.lat)?d.lat.toFixed(6):'-'} / çµŒåº¦:${Number.isFinite(d.lng)?d.lng.toFixed(6):'-'}</div>`;
      if (Number.isFinite(d.lat) && Number.isFinite(d.lng)){
        L.popup().setLatLng([d.lat,d.lng]).setContent(html).openOn(map);
      }
    }

  }); // initApp
  </script>

  <!-- Assist èµ·å‹•ï¼ˆdestLabel / rideHud / focusMarkers ãªã©ï¼‰ -->
  <script type="module" src="./src/assist/initAssist.js"></script>
</body>
</html>




