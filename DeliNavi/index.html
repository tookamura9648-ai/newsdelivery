<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DeliNavi</title>

  <!-- è»½é‡favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3EğŸ—ºï¸%3C/text%3E%3C/svg%3E">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- å›è»¢ãƒãƒ¼ã‚«ãƒ¼ -->
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>
  <!-- CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    html,body{height:100%;margin:0}
    body{background:#000;overscroll-behavior:none;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",Meiryo,sans-serif}
    #map{position:fixed;inset:0}

    /* å³ä¸Šã®æ“ä½œãƒ‘ãƒãƒ« */
    .panel{
      position:absolute;z-index:1000;left:10px;top:10px;background:#fff;
      padding:10px 12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.15)
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
    .btn{padding:6px 10px;border:1px solid #ccc;border-radius:8px;background:#f6f6f6;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .badge{background:#111;color:#fff;border-radius:10px;padding:3px 8px;font-weight:700}
    .small{font-size:12px;color:#666}

    /* ===== ä¸‹éƒ¨ã®é †è·¯ã‚«ãƒ¼ãƒ‰ï¼ˆé»’ï¼‰ ===== */
    .route-card{
      position:fixed; left:8px; right:8px; bottom:8px; z-index:9500;
      background: rgba(0,0,0,.90);  /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
      color:#fff; border-radius:14px; padding:10px 12px; box-shadow:0 10px 24px rgba(0,0,0,.35);
      display:flex !important; align-items:center; gap:10px;
      min-height:92px;  /* çŸ¢å°ãƒ©ãƒ™ãƒ«ã¨åŒã˜é«˜ã•ã«å›ºå®š */
    }
    @supports ((-webkit-backdrop-filter: none) or (backdrop-filter: none)) {
      .route-card{
        background: rgba(0,0,0,.82);
        -webkit-backdrop-filter: saturate(1.2) blur(2px);
        backdrop-filter: saturate(1.2) blur(2px);
      }
    }
    /*.route-card .meta{flex:1 1 auto; min-width:0; display:flex; flex-direction:column; justify-content:center; min-height:inherit}
    .route-card .title{font-weight:800; font-size:20px; line-height:1.2; letter-spacing:.06em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .route-card .addr{opacity:.95; font-size:13px; line-height:1.25; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .route-card .note{opacity:.85; font-size:12px; line-height:1.25; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px} */
    .route-card .menu-btn{flex:0 0 auto; padding:8px 12px; border-radius:9px; border:1px solid rgba(255,255,255,.25); background:#07445f; color:#fff; font-weight:700; cursor:pointer}

    /* åœ°å›³ä¸Šã®å¤§çŸ¢å°ã‚ªãƒ¼ãƒãƒ¬ã‚¤ */
    .turn-overlay{ position:fixed; inset:0; z-index:9400; pointer-events:none; display:none }
    .turn-overlay.show{ display:block }
    .turn-overlay canvas{ position:absolute; left:50%; top:50%; transform:translate(-50%,-60%); width:min(64vw,64vh); height:auto }

    /* Leafletã®ç•ªå·ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã¯éè¡¨ç¤ºï¼ˆæ··é›‘é˜²æ­¢ï¼‰ */
    .leaflet-tooltip{ display:none !important }

    /* HUDã®ã‚­ãƒ£ãƒ³ãƒã‚¹åè»¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ãªã‚‰ä½¿ã†ï¼‰ */
    #dn-hud-cv { transition: transform .15s ease; }
    body.hud-flip #dn-hud-cv { transform: rotate(180deg); }

    /* ç™½ã„å°ã‚«ãƒ¼ãƒ‰ã¯å¸¸ã«æ¶ˆã™ï¼ˆturns.jsãŒå‡ºã—ã¦ã‚‚éš ã™ï¼‰ */
    #dn-turn-card, .dn-turn-card{ display:none !important; visibility:hidden !important; pointer-events:none !important; }
  </style>
</head>
<body>
  <!-- åœ°å›³ -->
  <div id="map" aria-label="map"></div>

  <!-- åœ°å›³ä¸Šã®çŸ¢å°ã‚ªãƒ¼ãƒãƒ¬ã‚¤ -->
  <div id="turnOverlay" class="turn-overlay" aria-hidden="true">
    <canvas id="turnOverlayCv" width="512" height="512"></canvas>
  </div>

  <!-- ä¸‹ã®é †è·¯ã‚«ãƒ¼ãƒ‰ï¼ˆæ°åãƒ»ä½æ‰€ãƒ»å‚™è€ƒï¼‹Menuï¼‰ -->
  <div id="routeCard" class="route-card" role="region" aria-label="æ¬¡ã®é…é”å…ˆ">
    <div class="meta">
      <div id="rcAddr"  class="addr">â€”</div>
      <div id="rcTitle" class="title">â€”</div>
      <div id="rcNote"  class="note">â€”</div>
    </div>
    <button id="rcMenu" class="menu-btn">Menu</button>
  </div>

  <!-- å³ä¸Šã®æ“ä½œãƒ‘ãƒãƒ« -->
  <div class="panel">
    <div class="row">
      <span class="badge" id="counter">#0 / 0</span>
      <button class="btn" id="btnFit">å…¨ä½“è¡¨ç¤º</button>
      <button class="btn" id="btnPrev" disabled>â—€ å‰</button>
      <button class="btn" id="btnNext" disabled>æ¬¡ â–¶</button>
      <button class="btn" id="btnHUD">HUD</button>
      <button class="btn" id="btnQR">QRå…±æœ‰</button>
    </div>
    <div class="row">
      <button class="btn" id="btnGPS">GPSé–‹å§‹</button>
      <button class="btn" id="btnStop" disabled>åœæ­¢</button>
      <label class="small">åˆ°ç€åŠå¾„ <input type="number" id="radius" value="50" style="width:4.5em"> m</label>
    </div>
    <div class="row">
      <label class="small"><input type="checkbox" id="chkFollow" checked> ä¸­å¤®å›ºå®šï¼ˆè¿½å¾“ï¼‰</label>
      <label class="small"><input type="checkbox" id="chkHeading" checked> çŸ¢å°ï¼é€²è¡Œæ–¹å‘</label>
    </div>
    <div class="small" id="status">åˆæœŸåŒ–ä¸­â€¦</div>
  </div>

  <!-- QRãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="qrModal" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.5);align-items:center;justify-content:center">
    <div style="background:#fff;padding:16px 18px;border-radius:12px;text-align:center">
      <canvas id="qrCanvas" width="260" height="260"></canvas><br>
      <div style="margin-top:8px;font-size:12px" id="qrUrl"></div>
      <button class="btn" id="qrClose" style="margin-top:10px">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <script>
  (function whenReady(fn){
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, {once:true});
    else fn();
  })(function initApp(){

    // ====== è¨­å®š ======
    const CSV_URL = './assets/data/points.csv'; // name,address,note,lat,lngï¼ˆæ—¥æœ¬èªåˆ—åã‚‚å¯ï¼‰
    const OFFICIAL_ROUTE_URL = './assets/routes/official-route.geojson';
    const SHOW_PLANNED_LINE = false;

    // åˆ°ç€åˆ¤å®šãƒ»è‡ªå‹•ã‚ºãƒ¼ãƒ 
    const MIN_RADIUS = 8, ARRIVE_DWELL_MS = 2000, SPEED_SLOW_KMH = 8, ARRIVE_COOLDOWN_MS = 10000;
    const APPROACH_ZOOM_IN_M = 90, APPROACH_ZOOM_OUT_M = 140, APPROACH_ZOOM_LEVEL = 18, APPROACH_FLY_MS = 800;

    // HUDã¯æ‰‹å‹•ã®ã¿
    const HUD_MANUAL_ONLY = true;

    // ====== åœ°å›³ ======
    const map = L.map('map', {zoomControl:true, preferCanvas:true}).setView([35.0,135.87], 13);
    window.__DN_map = map;
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

    // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å
    const zc = map.zoomControl;
    if (zc && zc._zoomInButton) { zc._zoomInButton.setAttribute('title','æ‹¡å¤§'); zc._zoomInButton.setAttribute('aria-label','æ‹¡å¤§'); }
    if (zc && zc._zoomOutButton){ zc._zoomOutButton.setAttribute('title','ç¸®å°'); zc._zoomOutButton.setAttribute('aria-label','ç¸®å°'); }

    // ====== å…¬å¼ãƒ«ãƒ¼ãƒˆ ======
    const officialRouteGroup = L.featureGroup().addTo(map);
    let officialSegments = [], officialRouteFlat = [], legHighlight = null;

    // ====== CSVç›®çš„åœ° ======
    let csvRows = [];
    let destMarkers = [];
    let plannedLayer = null;

    // ====== å®Ÿèµ°ãƒ­ã‚° ======
    const liveTrack = L.polyline([], {color:'#222', weight:3}).addTo(map);

    // ====== è‡ªä½ç½®ãƒãƒ¼ã‚«ãƒ¼ï¼ˆé€²è¡Œæ–¹å‘å›è»¢ï¼‰ ======
    const userIcon = L.icon({
      iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
           <defs><filter id="s"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.4"/></filter></defs>
           <g filter="url(#s)">
             <circle cx="32" cy="32" r="9" fill="#fff"/>
             <polygon points="32,6 44,34 32,28 20,34" fill="#007aff"/>
           </g>
         </svg>`),
      iconSize:[44,44], iconAnchor:[22,22]
    });
    let userMarker = null, userAccCircle = null;
    let followMode = true, rotateToHeading = true;
    let lastLatLng = null, lastHeading = 0;

    // ====== UIãƒ˜ãƒ«ãƒ‘ ======
    const $ = s => document.querySelector(s);
    const setStatus = t => $('#status').textContent = t;

    // ====== çŠ¶æ…‹ï¼ˆåˆ°ç€ãƒ»è‡ªå‹•ã‚ºãƒ¼ãƒ ãƒ»ã‚³ãƒ³ãƒ‘ã‚¹ï¼‰ ======
    let __arriveSinceTs = 0, __arriveCooldownUntil = 0;
    let __autoZoomed = false, __autoZoomPrevZoom = null, __autoZoomTargetIdx = null;
    let __compassHeading = null, __headingLPF = null;

    // ====== ã‚¤ãƒ™ãƒ³ãƒˆé…ç·š ======
    $('#btnFit').addEventListener('click', fitAll);
    $('#btnPrev').addEventListener('click', e=>{ e.preventDefault(); stepCSV(-1); });
    $('#btnNext').addEventListener('click', e=>{ e.preventDefault(); stepCSV(+1); });
    $('#btnQR').addEventListener('click', showQR);
    $('#qrClose').addEventListener('click', ()=>{ $('#qrModal').style.display='none'; });

    $('#btnGPS').addEventListener('click', startGPS);
    $('#btnStop').addEventListener('click', stopGPS);
    $('#btnHUD').addEventListener('click', ()=> setHUD(!document.body.classList.contains('hud')) );

    $('#chkFollow').addEventListener('change', e=>{ followMode=e.target.checked; if(followMode && lastLatLng) map.setView(lastLatLng, map.getZoom(), {animate:false}); });
    $('#chkHeading').addEventListener('change', e=>{ rotateToHeading=e.target.checked; if(userMarker?.setRotationAngle) userMarker.setRotationAngle(rotateToHeading?lastHeading:0); });

    $('#rcMenu').addEventListener('click', ()=>{
      const p = document.querySelector('.panel'); if(!p) return;
      p.style.display = (p.style.display==='none') ? 'block' : 'none';
    });

    // èµ·å‹•æ™‚ã«HUD/åè»¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¾©å…ƒ
    if (localStorage.getItem('dnHudOn')==='1') document.body.classList.add('hud');
    if (localStorage.getItem('dnHudFlip')==='1') document.body.classList.add('hud-flip');
    if (localStorage.getItem('dnTurnInvert')==='1') document.body.classList.add('turn-invert');
    window.DN_requestHUD = (want)=>{ if (!HUD_MANUAL_ONLY) setHUD(!!want); }; // è‡ªå‹•è¦æ±‚ã¯ç„¡è¦–

    // ====== åˆæœŸãƒ­ãƒ¼ãƒ‰ ======
    Promise.all([loadOfficialRoute(), loadCSV()])
      .then(()=>{ setStatus('æº–å‚™OKã€‚GPSé–‹å§‹ã§ã‚¹ã‚¿ãƒ¼ãƒˆ'); fitAll(); })
      .catch(err=>{ console.error(err); setStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: '+err.message); });

    // ====== CSV èª­ã¿è¾¼ã¿ ======
    async function loadCSV(){
      const res = await fetch(CSV_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('points.csv not found');
      const text = await res.text();
      const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});

      csvRows = parsed.data.map(r=>({
        name: (r.name ?? r.æ°å ?? r.ãŠåå‰ ?? r.label ?? '').trim(),
        address: (r.address ?? r.ä½æ‰€ ?? r.æ‰€åœ¨åœ° ?? '').trim(),
        note: (r.note ?? r.å‚™è€ƒ ?? r.ãƒ¡ãƒ¢ ?? r.åŒºåˆ† ?? '').trim(),
        lat: parseFloat(r.lat ?? r.latitude ?? r.ç·¯åº¦),
        lng: parseFloat(r.lng ?? r.longitude ?? r.çµŒåº¦)
      }));

      // ãƒãƒ¼ã‚«ãƒ¼ä½œæˆï¼ˆåº§æ¨™ãŒã‚ã‚‹è¡Œã®ã¿ï¼‰
      destMarkers.forEach(m=>map.removeLayer(m)); destMarkers=[];
      if (plannedLayer){ map.removeLayer(plannedLayer); plannedLayer=null; }

      csvRows.forEach((d)=>{
        if (Number.isFinite(d.lat) && Number.isFinite(d.lng)) {
          const m = L.marker([d.lat,d.lng]).addTo(map);
          destMarkers.push(m);
        }
      });

      // Assistã¸ç™»éŒ² â†’ èµ·å‹•ç›´å¾Œã¯ã€Œæ¬¡ã ã‘ã€
      window.DN_registerDestinationMarkers && window.DN_registerDestinationMarkers(destMarkers, map);
      window.DN_setMarkerMode && window.DN_setMarkerMode('next');

      const rad = $('#radius'); if (rad){ rad.min=MIN_RADIUS; rad.step=1; if ((parseFloat(rad.value)||0) < MIN_RADIUS) rad.value = MIN_RADIUS; }

      if (SHOW_PLANNED_LINE) {
        const line = csvRows.filter(d=>Number.isFinite(d.lat)&&Number.isFinite(d.lng)).map(d=>[d.lat,d.lng]);
        plannedLayer = L.polyline(line, { color:'#1e6bff', weight:3, dashArray:'6 6' }).addTo(map);
      }

      setTimeout(()=>{ refreshCounterAndHighlight(); renderRouteCard(); }, 0);
    }

    // ====== å…¬å¼ãƒ«ãƒ¼ãƒˆ ======
    async function loadOfficialRoute(){
      const res = await fetch(OFFICIAL_ROUTE_URL + '?v=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('official-route.geojson not found');
      const gj = await res.json();

      officialRouteGroup.clearLayers();
      officialSegments = []; officialRouteFlat = [];

      const feats = (gj.type==='FeatureCollection') ? (gj.features||[]) : [gj];
      feats.forEach(ft=>{
        if(!ft?.geometry) return;
        const color = (ft.properties?.leg==='back') ? '#ff8c00' : '#00a7a7';
        const segs = [];
        if(ft.geometry.type==='LineString'){
          if(ft.geometry.coordinates?.length>=2) segs.push(ft.geometry.coordinates);
        }else if(ft.geometry.type==='MultiLineString'){
          (ft.geometry.coordinates||[]).forEach(c=>{ if(c?.length>=2) segs.push(c); });
        }
        segs.forEach(coords=>{
          const latlngs = coords.map(([lng,lat])=>[lat,lng]);
          L.polyline(latlngs, {color, weight:5, opacity:.9}).addTo(officialRouteGroup);
          officialSegments.push(latlngs);
          officialRouteFlat.push(...latlngs);
        });
      });
    }

    // ====== è¡¨ç¤ºç¯„å›² ======
    function fitAll(){
      const b = L.latLngBounds([]);
      if(officialRouteGroup.getLayers().length) b.extend(officialRouteGroup.getBounds());
      if(plannedLayer) b.extend(plannedLayer.getBounds());
      if(destMarkers.length) b.extend(L.featureGroup(destMarkers).getBounds());
      if(legHighlight) b.extend(legHighlight.getBounds());
      if(b.isValid()) map.fitBounds(b, {padding:[20,20]});
    }

    // ====== é †è·¯ã‚«ãƒ¼ãƒ‰æ›´æ–° ======
    function renderRouteCard(){
      const rec = window.DN_destLabelCurrent?.();
      $('#rcAddr').textContent  = rec?.address || rec?.ä½æ‰€ || '';
      $('#rcTitle').textContent = rec?.name || rec?.æ°å || rec?.ãŠåå‰ || '';
      $('#rcNote').textContent  = rec?.note || rec?.å‚™è€ƒ || '';
    }

    // ====== CSVé † å‰å¾Œç§»å‹• ======
    let lastRec = null;
    function stepCSV(delta){
      const curr = window.DN_destLabelCurrent?.() || null;
      if (curr) lastRec = curr;

      const rec = window.DN_destLabelMove ? window.DN_destLabelMove(delta) : null;
      if (rec && Number.isFinite(rec.lat) && Number.isFinite(rec.lng)) map.panTo([rec.lat, rec.lng]);
      refreshCounterAndHighlight(rec, lastRec);
      renderRouteCard();
      autoZoomReset(true); // åˆ‡æ›¿æ™‚ã¯å€ç‡ã‚’æˆ»ã™
    }

    function refreshCounterAndHighlight(nowRec = window.DN_destLabelCurrent?.(), prevRec = lastRec){
      const idx   = window.DN_destLabelIndex?.() ?? 0;
      const total = window.DN_destLabelCount?.() ?? csvRows.length;
      $('#counter').textContent = `#${total ? idx+1 : 0} / ${total}`;
      $('#btnPrev').disabled = (idx <= 0);
      $('#btnNext').disabled = (idx >= total-1);
      updateLegHighlight(prevRec, nowRec);
      window.DN_setTurnLeg && window.DN_setTurnLeg(prevRec, nowRec); // ã‚¿ãƒ¼ãƒ³æ¡ˆå†…ã¸
    }

    // ====== åŒºé–“ãƒã‚¤ãƒ©ã‚¤ãƒˆ ======
    function nearestIndexOnRoute(pt){
      if (!officialRouteFlat.length) return 0;
      let best = 0, bestD = Infinity;
      for (let i=0;i<officialRouteFlat.length;i++){
        const d = distanceMeters(pt, officialRouteFlat[i]);
        if (d < bestD){ bestD = d; best = i; }
      }
      return best;
    }
    function updateLegHighlight(prevRec, nowRec){
      if (legHighlight) { map.removeLayer(legHighlight); legHighlight=null; }
      if (!nowRec || !Number.isFinite(nowRec.lat) || !Number.isFinite(nowRec.lng)) return;

      let A=null, B=[nowRec.lat, nowRec.lng];
      if (prevRec && Number.isFinite(prevRec.lat) && Number.isFinite(prevRec.lng)) A=[prevRec.lat, prevRec.lng]; else A=B;

      if (!officialRouteFlat.length) {
        if (A && B) legHighlight = L.polyline([A,B], {color:'#ff2970', weight:7}).addTo(map);
        return;
      }
      const s = nearestIndexOnRoute(A);
      const e = nearestIndexOnRoute(B);
      const seg = (s<=e) ? officialRouteFlat.slice(s, e+1) : officialRouteFlat.slice(e, s+1).reverse();
      if (seg.length >= 2) legHighlight = L.polyline(seg, { color:'#ff2970', weight:7, opacity:0.9 }).addTo(map);
    }

    // ====== GPS ======
    let watchId = null;
    function startGPS(){
      if(!('geolocation' in navigator)){ setStatus('ã“ã®ç«¯æœ«ã¯GPSéå¯¾å¿œ'); return; }
      $('#btnGPS').disabled = true; $('#btnStop').disabled = false; setStatus('æ¸¬ä½ä¸­â€¦');
      liveTrack.setLatLngs([]);

      enableCompass(); // ã‚³ãƒ³ãƒ‘ã‚¹è¨±å¯ï¼ˆiOSã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç›´å¾Œã§OKï¼‰

      watchId = navigator.geolocation.watchPosition(onPos, onErr, {
        enableHighAccuracy:true, maximumAge:0, timeout:15000
      });
    }
    function stopGPS(){
      if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      $('#btnGPS').disabled = false; $('#btnStop').disabled = true; setStatus('åœæ­¢ã—ã¾ã—ãŸ');
    }
    function onPos(pos){
      const { latitude:lat, longitude:lng, accuracy, heading:h } = pos.coords;
      const curr = [lat, lng];

      // è‡ªä½ç½®
      if (!userMarker) {
        userMarker = L.marker(curr, { icon:userIcon, rotationAngle:0, rotationOrigin:'center center' }).addTo(map);
        userAccCircle = L.circle(curr, { radius: accuracy||0, color:'#2b8', weight:1, fillOpacity:0.07 }).addTo(map);
      } else {
        userMarker.setLatLng(curr);
        userAccCircle?.setLatLng(curr).setRadius(accuracy||0);
      }

      // é€²è¡Œæ–¹å‘ï¼ˆGPS course / ã‚³ãƒ³ãƒ‘ã‚¹ / ç›´å‰ãƒ™ã‚¯ãƒˆãƒ«ï¼‰
      let hdg = getHeadingFromSensors(pos, lastLatLng, curr);
      if (rotateToHeading && userMarker.setRotationAngle) userMarker.setRotationAngle(hdg);
      lastHeading = hdg; lastLatLng = curr;

      if (followMode) map.setView(curr, map.getZoom(), {animate:false});
      liveTrack.addLatLng(curr);

      // åˆ°ç€åˆ¤å®šãƒ»è‡ªå‹•ã‚ºãƒ¼ãƒ 
      const rec = window.DN_destLabelCurrent?.();
      if (rec && Number.isFinite(rec.lat) && Number.isFinite(rec.lng)) {
        const d = distanceMeters(curr, [rec.lat, rec.lng]);
        autoZoomMaybe(d, curr); // â† è¿‘ã¥ã„ãŸã‚‰ã‚ºãƒ¼ãƒ 

        const acc = accuracy ?? 30;
        const userR = parseFloat($('#radius').value) || 50;
        const autoR = Math.round(acc * 0.6 + 3);
        const effR  = Math.max(MIN_RADIUS, Math.min(userR, autoR));

        const now = performance.now();
        const speedKmh = (pos.coords.speed != null && isFinite(pos.coords.speed)) ? pos.coords.speed * 3.6 : null;
        const isSlow = (speedKmh == null) ? true : (speedKmh <= SPEED_SLOW_KMH);
        const cooldownOK = now >= __arriveCooldownUntil;

        if (d <= effR) { if (!__arriveSinceTs) __arriveSinceTs = now; } else { __arriveSinceTs = 0; }
        const hasDwelled = __arriveSinceTs && ((now - __arriveSinceTs) >= ARRIVE_DWELL_MS);
        setStatus(`ç²¾åº¦Â±${Math.round(accuracy||0)}m / ç›®çš„åœ°ã¾ã§ ${Math.round(d)}m / åˆ¤å®š${effR}m`);

        if (d <= effR && hasDwelled && isSlow && cooldownOK) {
          ping(); showArrive(rec);
          __arriveSinceTs = 0; __arriveCooldownUntil = now + ARRIVE_COOLDOWN_MS;
          autoZoomReset(true); // åˆ°ç€æ™‚ã«å€ç‡ã‚’æˆ»ã™
        }
      }
    }
    function onErr(err){ setStatus('GPSã‚¨ãƒ©ãƒ¼: ' + err.message); }

    // ====== ã‚³ãƒ³ãƒ‘ã‚¹ ======
    function enableCompass(){
      if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(res=>{
          if (res === 'granted') {
            window.addEventListener('deviceorientation', onDeviceOrientation, true);
          }
        }).catch(()=>{});
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientationabsolute' in window ? 'deviceorientationabsolute' : 'deviceorientation', onDeviceOrientation, true);
      }
    }
    function onDeviceOrientation(e){
      const alpha = (typeof e.alpha === 'number') ? e.alpha : null;
      if (alpha == null) return;
      const heading = (360 - alpha) % 360; // åŒ—=0Â°
      __compassHeading = heading;
    }
    function smoothHeading(deg){
      if (__headingLPF == null) { __headingLPF = deg; return deg; }
      let diff = ((deg - __headingLPF + 540) % 360) - 180;
      __headingLPF = (__headingLPF + diff * 0.25 + 360) % 360;
      return __headingLPF;
    }
    function getHeadingFromSensors(pos, lastLL, currLL){
      const h = (pos.coords && Number.isFinite(pos.coords.heading)) ? pos.coords.heading : null;
      const speed = (pos.coords.speed != null && isFinite(pos.coords.speed)) ? pos.coords.speed : 0; // m/s
      const slow  = speed < 1.5;
      let cand = null;
      if (!slow && h != null) cand = h;
      else if (__compassHeading != null) cand = __compassHeading;
      else if (lastLL) cand = bearing(lastLL, currLL);
      else cand = lastHeading || 0;
      return smoothHeading((cand + 360) % 360);
    }

    // ====== åˆ°ç€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ======
    function showArrive(d){
      const html = `<div><strong>åˆ°ç€:</strong> ${d.name||''}<br>
        ç·¯åº¦:${Number.isFinite(d.lat)?d.lat.toFixed(6):'-'} / çµŒåº¦:${Number.isFinite(d.lng)?d.lng.toFixed(6):'-'}</div>`;
      if (Number.isFinite(d.lat) && Number.isFinite(d.lng)){
        L.popup().setLatLng([d.lat,d.lng]).setContent(html).openOn(map);
      }
    }

    // ====== è‡ªå‹•ã‚ºãƒ¼ãƒ  ======
    function autoZoomMaybe(distM, hereLatLng){
      const idx = window.DN_destLabelIndex?.();
      if (idx == null) return;
      if (__autoZoomTargetIdx !== idx) { autoZoomReset(false); __autoZoomTargetIdx = idx; }
      if (!__autoZoomed && distM <= APPROACH_ZOOM_IN_M){
        __autoZoomPrevZoom = map.getZoom(); __autoZoomed = true;
        map.flyTo(hereLatLng, APPROACH_ZOOM_LEVEL, { animate:true, duration: APPROACH_FLY_MS/1000 });
      }
      if (__autoZoomed && distM >= APPROACH_ZOOM_OUT_M) autoZoomRestore();
    }
    function autoZoomRestore(){
      if (!__autoZoomed) return;
      const z = (__autoZoomPrevZoom ?? 15);
      __autoZoomed = false; __autoZoomPrevZoom = null;
      map.flyTo(map.getCenter(), z, { animate:true, duration: APPROACH_FLY_MS/1000 });
    }
    function autoZoomReset(restore=true){ if (restore) autoZoomRestore(); __autoZoomed=false; __autoZoomPrevZoom=null; }

    // ====== HUDæ‰‹å‹•åˆ‡æ›¿ ======
    function setHUD(on){
      document.body.classList.toggle('hud', !!on);
      localStorage.setItem('dnHudOn', on ? '1' : '0');
    }

    // ====== ã‚µã‚¦ãƒ³ãƒ‰/QR/è·é›¢ ======
    let audioCtx = null;
    function ping(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.frequency.value = 880; g.gain.value = 0.0001;
        o.connect(g).connect(audioCtx.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.25);
        o.stop(audioCtx.currentTime+0.26);
      }catch(e){}
      if(navigator.vibrate) navigator.vibrate([200,100,200]);
    }
    function showQR(){
      const url = location.origin + location.pathname + location.search;
      const canvas = document.getElementById('qrCanvas');
      QRCode.toCanvas(canvas, url, { width: 260, margin: 1 }, (err)=>{ if(err) console.error(err); });
      document.getElementById('qrUrl').textContent = url;
      document.getElementById('qrModal').style.display = 'flex';
    }
    function distanceMeters(a,b){
      const toR = x=>x*Math.PI/180, R=6371000;
      const dLat=toR(b[0]-a[0]), dLng=toR(b[1]-a[1]);
      const s1=Math.sin(dLat/2)**2 + Math.cos(toR(a[0]))*Math.cos(toR(b[0]))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s1));
    }
    function bearing(a,b){
      const toR=d=>d*Math.PI/180, toD=r=>r*180/Math.PI;
      const Ï†1=toR(a[0]), Ï†2=toR(b[0]), Î”Î»=toR(b[1]-a[1]);
      const y=Math.sin(Î”Î»)*Math.cos(Ï†2);
      const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
      return (toD(Math.atan2(y,x))+360)%360;
    }

    // ====== åœ°å›³ã‚ªãƒ¼ãƒãƒ¬ã‚¤ï¼ˆturns.js ã‹ã‚‰å‘¼ã°ã‚Œã‚‹æƒ³å®šï¼‰=====
    window.DN_setMapOverlay = function(dir, bend, next, dist){
      const host = document.getElementById('turnOverlay');
      const cv   = document.getElementById('turnOverlayCv');
      if (!host || !cv) return;

      const SHOW_TH = 80; // m
      const show = (next && next.type!=='arrive' && dist <= SHOW_TH);
      host.classList.toggle('show', show);
      const ctx = cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height);
      if (!show) return;

      const W=cv.width, H=cv.height;
      const bendDeg = Math.max(25, Math.min(180, Math.round(bend || 90)));
      const sign = (dir==='left' || dir==='slight_left') ? -1 : +1;

      const S = Math.min(W,H);
      const body = Math.round(S*0.12), outline = Math.round(body*1.28);
      const preLen = Math.round(S*0.20), postLen = Math.round(S*0.22), curveLen = Math.round(S*0.30);
      const x0 = W*0.32, y0 = H*0.78;
      const P1 = {x:x0, y:y0-preLen};
      const rad = bendDeg*Math.PI/180, dirX=Math.sin(rad)*sign, dirY=-Math.cos(rad);
      const kLen = curveLen*(90/bendDeg);
      const P2={x:P1.x+dirX*kLen, y:P1.y+dirY*kLen};
      const cGain=0.55*(bendDeg/90), C1={x:P1.x, y:P1.y-cGain*curveLen}, C2={x:P2.x-dirX*cGain*curveLen, y:P2.y-dirY*cGain*curveLen};
      const P3={x:P2.x+dirX*postLen, y:P2.y+dirY*postLen};

      const head=(w)=>{ const nx=-dirY, ny=dirX, tip=P3, base={x:P3.x-dirX*(w*1.65), y:P3.y-dirY*(w*1.65)},
        L={x:base.x+nx*w, y:base.y+ny*w}, R={x:base.x-nx*w, y:base.y-ny*w};
        ctx.moveTo(tip.x,tip.y); ctx.lineTo(L.x,L.y); ctx.lineTo(R.x,R.y); ctx.closePath(); };
      const stroke=(w,color)=>{ ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(P1.x,P1.y);
        ctx.bezierCurveTo(C1.x,C1.y,C2.x,C2.y,P2.x,P2.y); ctx.lineTo(P3.x,P3.y);
        ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=color; ctx.lineWidth=w; ctx.stroke();
        ctx.beginPath(); head(w*0.62); ctx.fillStyle=color; ctx.fill(); };

      stroke(outline,'#0b3a5a'); stroke(body,'#12b24a');

      // ç™½ãƒ˜ãƒƒãƒ‰ï¼ˆé€²è¡Œæ–¹å‘ï¼‰
      const iw = Math.max(14, Math.round(body*0.85));
      const nx=-dirY, ny=dirX;
      const tip=P3, base={x:P3.x-dirX*(iw*1.25), y:P3.y-dirY*(iw*1.25)},
            L={x:base.x+nx*(iw*0.70), y:base.y+ny*(iw*0.70)},
            R={x:base.x-nx*(iw*0.70), y:base.y-ny*(iw*0.70)};
      ctx.beginPath(); ctx.moveTo(tip.x,tip.y); ctx.lineTo(L.x,L.y); ctx.lineTo(R.x,R.y); ctx.closePath();
      ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fill();
      ctx.beginPath(); ctx.moveTo(tip.x,tip.y); ctx.lineTo(L.x,L.y); ctx.lineTo(R.x,R.y); ctx.closePath();
      ctx.fillStyle='#fff'; ctx.fill();
    };

  }); // initApp
  </script>

  <!-- Assistï¼ˆdestLabel / turns / rideHud ãªã©ï¼‰ -->
  <script type="module" src="./src/assist/initAssist.js"></script>
</body>
</html>








