<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒãƒ«ãƒç›®çš„åœ°ãƒŠãƒ“ï¼ˆLeaflet æ­£å¼ç‰ˆï¼‰</title>

<!-- Leaflet -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="anonymous"></script>

<style>
  :root{ --ink:#111; --sub:#666; --band:#111; --pill:#eef; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; color:var(--ink) }
  header{ padding:12px; background:var(--band); color:#fff }
  .wrap{ padding:12px; display:grid; gap:10px }
  textarea{ width:100%; height:140px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px }
  input,button{ padding:10px; font-size:16px }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .pill{ background:var(--pill); padding:6px 10px; border-radius:999px; display:inline-block; font-size:12px }
  #map{ width:100%; height:60vh; border-radius:10px; overflow:hidden }
  .status{ font-size:14px }
  .small{ font-size:12px; color:var(--sub) }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9999 }
  .modal-inner{ background:#fff; max-width:92vw; max-height:85vh; padding:10px; border-radius:14px; text-align:center }
  .modal-inner img{ max-width:100%; max-height:70vh; display:block; margin:0 auto }
  .close{ margin-top:8px; padding:8px 12px; font-size:16px }
  .badge{ background:#f3f4f6; padding:4px 8px; border-radius:8px }
  .emoji-marker{ font-size:22px; line-height:22px; transform: translate(-50%,-50%); text-shadow: 0 0 4px rgba(255,255,255,.9); }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .row input[type=url]{ min-width:280px }
</style>
</head>
<body>
<header>
  <div><strong>ãƒãƒ«ãƒç›®çš„åœ°ãƒŠãƒ“ï¼ˆLeaflet æ­£å¼ç‰ˆï¼‰</strong></div>
  <div class="pill">åˆ°ç€â†’ç”»åƒè¡¨ç¤ºâ†’æ¬¡ã¸ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰ï¼APIã‚­ãƒ¼ä¸è¦</div>
</header>

<div class="wrap">
  <!-- å†…è”µãƒªã‚¹ãƒˆ -->
  <details open>
    <summary><b>å†…è”µãƒªã‚¹ãƒˆï¼ˆé…åˆ— DESTSï¼‰</b>ã‚’ä½¿ã†å ´åˆ</summary>
    <div class="small">ä¸‹ã® <code>DESTS</code> ã‚’ç·¨é›†ã—ã¦ã€Œå†…è”µãƒªã‚¹ãƒˆèª­è¾¼ã€ã‚’æŠ¼ã—ã¾ã™ã€‚</div>
    <button id="loadArrayBtn">å†…è”µãƒªã‚¹ãƒˆèª­è¾¼</button>
  </details>

  <!-- æ‰‹è²¼ã‚ŠCSV -->
  <details>
    <summary>CSVã‹ã‚‰èª­ã¿è¾¼ã‚€å ´åˆï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰</summary>
    <div class="small">
      å½¢å¼1ï¼ˆå¾“æ¥ï¼‰ï¼š<code>label,lat,lng[,img][,radius]</code><br>
      å½¢å¼2ï¼ˆ2è¡Œãƒ©ãƒ™ãƒ«ï¼‰ï¼š<code>name,address,lat,lng[,img][,radius]</code>ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼†åˆ°ç€æ™‚ã«2è¡Œè¡¨ç¤ºï¼‰
    </div>
    <textarea id="csvInput" placeholder="ä¾‹:
name,address,lat,lng,img,radius
å±±ç”° å¤ªéƒ,å¤§æ´¥å¸‚æ „ç”º2-1,35.0000,135.9000,,100
ç”°ä¸­ èŠ±å­,å¤§æ´¥å¸‚é³¥å±…å·ç”º4-3,35.0100,135.9100,https://example.com/p1.jpg,80"></textarea>
    <div class="controls">
      <button id="loadCsvBtn">CSVèª­è¾¼</button>
      <button id="saveCsvBtn" title="ã“ã®ç«¯æœ«ã«ä¿å­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageï¼‰">CSVä¿å­˜</button>
      <button id="restoreCsvBtn" title="ä¿å­˜æ¸ˆã¿CSVã‚’å¾©å…ƒ">CSVå¾©å…ƒ</button>
    </div>
  </details>

  <!-- å¤–éƒ¨URL CSV -->
  <details>
    <summary>å¤–éƒ¨CSVã‚’URLã‹ã‚‰èª­ã¿è¾¼ã‚€</summary>
    <div class="row">
      <input id="csvUrl" type="url" placeholder="https://example.com/data/dests.csv">
      <button id="loadUrlBtn">URLèª­è¾¼</button>
      <button id="saveUrlBtn">URLä¿å­˜</button>
      <button id="restoreUrlBtn">URLå¾©å…ƒ</button>
    </div>
    <div class="small">åŒã˜Netlifyã‚µã‚¤ãƒˆé…ä¸‹ã«ç½®ãã®ãŒCORSçš„ã«ç°¡å˜ã§ã™ï¼ˆä¾‹ï¼š<code>/data/dests.csv</code>ï¼‰ã€‚</div>
  </details>

  <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
  <div class="controls">
    <button id="startBtn" disabled>è¿½è·¡é–‹å§‹</button>
    <button id="skipBtn" disabled>ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¬¡ã®ç›®çš„åœ°ï¼‰</button>
    <button id="resetBtn">å…¨ãƒªã‚»ãƒƒãƒˆ</button>

    <!-- ãƒ«ãƒ¼ãƒˆç·š -->
    <button id="drawRouteBtn" disabled>ãƒ«ãƒ¼ãƒˆè¡¨ç¤º/æ›´æ–°</button>
    <button id="fitRouteBtn" disabled>å…¨ä½“è¡¨ç¤º</button>

    <!-- å®Ÿç§»å‹•è»Œè·¡ -->
    <button id="toggleTrackBtn" disabled>è»Œè·¡è¨˜éŒ² ON</button>
    <button id="clearTrackBtn" disabled>è»Œè·¡ã‚¯ãƒªã‚¢</button>
    <button id="exportGpxBtn" disabled>GPXä¿å­˜</button>
    <button id="exportGeoBtn" disabled>GeoJSONä¿å­˜</button>

    <!-- é€šçŸ¥ -->
    <label style="display:flex;gap:8px;align-items:center">
      <input id="soundEnable" type="checkbox" checked> ã‚µã‚¦ãƒ³ãƒ‰
    </label>
    <label style="display:flex;gap:8px;align-items:center">
      <input id="vibeEnable" type="checkbox" checked> ãƒã‚¤ãƒ–
    </label>
    <button id="testNotifyBtn" title="åŠ¹æœéŸ³/ãƒã‚¤ãƒ–ã®ãƒ†ã‚¹ãƒˆ">é€šçŸ¥ãƒ†ã‚¹ãƒˆ</button>

    <span class="badge" id="progress">æœªèª­è¾¼</span>
  </div>

  <div class="status" id="status">çŠ¶æ…‹: -</div>
  <div id="map"></div>

  <div class="small">
    ãƒ¡ãƒ¢: ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®ç¶™ç¶šæ¸¬ä½ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚ç”»é¢ã‚’é–‹ã„ãŸã¾ã¾åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚<br>
    ãƒ«ãƒ¼ãƒˆå›ºå®šé‹ç”¨ãªã‚‰ <code>DESTS</code> ã‚’ç·¨é›†ã—ã¦ä½¿ã†ã®ãŒç°¡å˜ã§ã™ã€‚
  </div>
</div>

<!-- åˆ°ç€ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="imgModal" role="dialog" aria-modal="true">
  <div class="modal-inner">
    <div id="imgTitle" style="margin:6px 0 8px; font-weight:600;"></div>
    <img id="showImg" alt="åˆ°ç€ç”»åƒ" />
    <button class="close" id="closeModal">æ¬¡ã®ç›®çš„åœ°ã¸</button>
  </div>
</div>

<script>
/* ========= 1) äº‹å‰ç™»éŒ²ï¼ˆå›ºå®šãƒ«ãƒ¼ãƒˆç”¨ã®å†…è”µé…åˆ—ï¼‰ =========
   - labelï¼ˆæ—§ï¼‰ã§ã‚‚ã€name/addressã®2è¡Œã§ã‚‚OK
   - labelHtml/labelText ã‚’è‡ªå‰ã§æŒ‡å®šã™ã‚Œã°ãã®ã¾ã¾è¡¨ç¤ºã—ã¾ã™
*/
const DESTS = [
  { name:"æ»‹è³€çœŒåº(ä¾‹)", address:"å¤§æ´¥å¸‚äº¬ç”º4ä¸ç›®1-1", lat:35.00450, lng:135.86860, img:"", radius:120 },
  { name:"ã‚µãƒ³ãƒ—ãƒ«A", address:"å¤§æ´¥å¸‚", lat:35.02000, lng:135.88000, img:"https://picsum.photos/600/400?random=1", radius:100 },
  { name:"ã‚µãƒ³ãƒ—ãƒ«B", address:"å¤§æ´¥å¸‚", lat:35.03050, lng:135.89200, img:"https://picsum.photos/600/400?random=2", radius:90 }
];

/* ================== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ================== */
const $ = (id)=>document.getElementById(id);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function haversine(a, b){ // a={lat,lng}, b={lat,lng}, return meters
  const R=6371000, toRad=(d)=>d*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
function setStatus(s){ $('status').textContent = "çŠ¶æ…‹: " + s; }
function createEmojiMarker(latlng, emoji){
  const icon = L.divIcon({className:'emoji-marker', html:emoji, iconSize:[22,22], iconAnchor:[11,11]});
  return L.marker(latlng, {icon});
}
function downloadFile(filename, content, type="application/octet-stream"){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function escapeHtml(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function fmtMeters(m){ return (m < 1000) ? `${Math.round(m)} m` : `${(m/1000).toFixed(2)} km`; }

/* ================== CSVãƒ‘ãƒ¼ã‚¹ï¼ˆå¼·ã‚ï¼2è¡Œãƒ©ãƒ™ãƒ«å¯¾å¿œï¼‰ ================== */
function csvParse(text){
  const rows=[]; let row=[], field="", inQ=false;
  for(let i=0;i<text.length;i++){
    const c = text[i];
    if(inQ){
      if(c === '"'){
        if(text[i+1] === '"'){ field+='"'; i++; } else { inQ=false; }
      }else{ field += c; }
    }else{
      if(c === '"'){ inQ=true; }
      else if(c === ','){ row.push(field.trim()); field=""; }
      else if(c === '\n' || c === '\r'){
        if(c === '\r' && text[i+1] === '\n') i++;
        row.push(field.trim()); field="";
        if(row.some(v=>v!=='')) rows.push(row);
        row=[];
      }else{ field += c; }
    }
  }
  row.push(field.trim());
  if(row.some(v=>v!=='')) rows.push(row);
  return rows;
}

function parseCsvToTargets(text){
  const rows = csvParse(text);
  if(rows.length === 0) return [];
  const lower = rows[0].map(s=>s.toLowerCase());
  const hasHeader = ['label','name','address','addr','label1','label2','lat','lng'].some(k => lower.includes(k));

  let idx = { name:-1, address:-1, lat:1, lng:2, img:3, radius:4 };
  let start = 0;

  const find = (keys)=> keys.map(k=>lower.indexOf(k)).find(i=>i>=0);

  if(hasHeader){
    start = 1;
    idx = {
      name:    find(['name','label1','æ°å']),
      address: find(['address','addr','label2','ä½æ‰€']),
      lat:     find(['lat','latitude','ç·¯åº¦']),
      lng:     find(['lng','lon','longitude','çµŒåº¦']),
      img:     find(['img','image','ç”»åƒ']),
      radius:  find(['radius','r','åŠå¾„']),
    };
    // å¾“æ¥: label,lat,lng,img,radius ã‚‚ã‚µãƒãƒ¼ãƒˆ
    if(idx.name===-1 && lower.includes('label')) idx.name = lower.indexOf('label');
  }else{
    // ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ï¼šå…ˆé ­2åˆ—ã‚’ name,address ã¨ã¿ãªã™ï¼ˆå¾“æ¥4åˆ—å½¢å¼ã«ã‚‚å¯¾å¿œï¼‰
    idx = { name:0, address:1, lat:2, lng:3, img:4, radius:5 };
  }

  const out=[];
  for(let i=start;i<rows.length;i++){
    const r = rows[i];
    const name    = (idx.name>=0 && r[idx.name]) ? r[idx.name] : (r[0]||"");
    const address = (idx.address>=0 && r[idx.address]) ? r[idx.address] : (r[1]||"");
    const latVal  = (idx.lat>=0 && r[idx.lat]) ? r[idx.lat] : r[2];
    const lngVal  = (idx.lng>=0 && r[idx.lng]) ? r[idx.lng] : r[3];
    const lat = parseFloat(latVal), lng = parseFloat(lngVal);
    if(!Number.isFinite(lat) || !Number.isFinite(lng)) continue;
    const img    = (idx.img>=0 && r[idx.img]) ? r[idx.img] : "";
    const radius = parseInt((idx.radius>=0 && r[idx.radius]) ? r[idx.radius] : "100", 10);
    const radiusOk = (Number.isFinite(radius) && radius>0) ? radius : 100;

    const labelHtml = (name || address)
      ? `<div>${escapeHtml(name)}<br><small>${escapeHtml(address)}</small></div>`
      : `<div>${escapeHtml(r[0]||'ç›®çš„åœ°')}</div>`;
    const labelText = (name || address) ? `${name} / ${address}` : (r[0]||'ç›®çš„åœ°');

    out.push({ labelHtml, labelText, latLng:{lat, lng}, img: img || null, radius: radiusOk });
  }
  return out;
}

async function fetchCsvText(url){
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.text();
}

function fromArray(arr){
  const out=[];
  for(const it of arr){
    const lat = parseFloat(it.lat), lng = parseFloat(it.lng);
    const radius = (Number.isFinite(it.radius) && it.radius>0) ? it.radius : 100;
    const labelHtml = it.labelHtml
      ? it.labelHtml
      : (it.name || it.address)
        ? `<div>${escapeHtml(it.name||'')}<br><small>${escapeHtml(it.address||'')}</small></div>`
        : `<div>${escapeHtml(it.label||'ç›®çš„åœ°')}</div>`;
    const labelText = it.labelText
      ? it.labelText
      : (it.name || it.address)
        ? `${it.name||''} / ${it.address||''}`
        : (it.label || 'ç›®çš„åœ°');
    out.push({ labelHtml, labelText, latLng:{lat, lng}, img:(it.img||null), radius });
  }
  return out;
}

/* ================== åœ°å›³ãƒ»æ¡ˆå†…ãƒ­ã‚¸ãƒƒã‚¯ ================== */
let map, meMarker=null, meCircle=null, watchId=null;
let targets=[], currentIdx=0, arrivalLock=false;
let destMarker=null, destCircle=null;
const preloaded = new Map();

/* ãƒ«ãƒ¼ãƒˆç·šï¼ˆå…¨ä½“ï¼‰ã¨èµ°ç ´ç·šï¼ˆåˆ°é”æ¸ˆï¼‰ */
let routeLine=null;      // ç›®çš„åœ°å…¨ä½“ï¼ˆç°ï¼‰
let traveledLine=null;   // åˆ°é”æ¸ˆã¿åŒºé–“ï¼ˆèµ¤ï¼‰
function getRouteCoords(){ return targets.map(t=>[t.latLng.lat, t.latLng.lng]); }
function drawRoute(){
  const coords = getRouteCoords();
  if(coords.length < 2) return;
  if(routeLine){ routeLine.remove(); }
  routeLine = L.polyline(coords, { color:'#444', weight:3, opacity:0.6, dashArray:'6,8' }).addTo(map);
}
function fitRouteBounds(){
  const coords = getRouteCoords();
  if(!coords || coords.length===0) return;
  if(coords.length===1){ map.setView(coords[0], 15); }
  else{ map.fitBounds(L.latLngBounds(coords), { padding:[30,30] }); }
}
function redrawTraveled(){
  const coords = getRouteCoords();
  const upto = Math.max(0, Math.min(currentIdx, coords.length-1));
  const partial = coords.slice(0, upto+1);
  if(partial.length < 2){ if(traveledLine){ traveledLine.remove(); traveledLine=null; } return; }
  if(traveledLine){ traveledLine.remove(); }
  traveledLine = L.polyline(partial, { color:'#d33', weight:4, opacity:0.9 }).addTo(map);
}

/* å®Ÿç§»å‹•ã®è»Œè·¡ï¼ˆç”Ÿãƒ­ã‚°ï¼‰ */
let trackRecording = false;
let trackPoints = [];             // {lat,lng,time}
let trackLine = null;             // ãƒãƒªãƒ©ã‚¤ãƒ³ï¼ˆé’ï¼‰
let trackDistance = 0;
const TRACK_MIN_DIST = 3;         // m
const TRACK_MIN_TIME_MS = 1500;   // ms
function toggleTrack(){
  trackRecording = !trackRecording;
  $('toggleTrackBtn').textContent = trackRecording ? 'è»Œè·¡è¨˜éŒ² OFF' : 'è»Œè·¡è¨˜éŒ² ON';
}
function clearTrack(){
  trackPoints = []; trackDistance = 0;
  if(trackLine){ trackLine.remove(); trackLine=null; }
  setStatus('è»Œè·¡ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
}
function appendTrackPoint(lat, lng, tms){
  const now = {lat, lng, time: tms};
  const last = trackPoints.length ? trackPoints[trackPoints.length-1] : null;
  if(last){
    const dt = tms - last.time;
    const dd = haversine(last, now);
    if(dt < TRACK_MIN_TIME_MS && dd < TRACK_MIN_DIST) return;
    trackDistance += dd;
  }
  trackPoints.push(now);
  if(!trackLine){
    trackLine = L.polyline(trackPoints.map(p=>[p.lat, p.lng]), { weight:4, opacity:0.8, color:'#1e90ff' }).addTo(map);
  }else{
    trackLine.setLatLngs(trackPoints.map(p=>[p.lat, p.lng]));
  }
}
function exportGeoJSON(){
  const gj = {
    type: "FeatureCollection",
    features: [{
      type: "Feature",
      geometry: { type: "LineString", coordinates: trackPoints.map(p=>[p.lng, p.lat]) },
      properties: { name: "Recorded Track", distance_m: Math.round(trackDistance) }
    }]
  };
  downloadFile(`track_${new Date().toISOString().replace(/[:.]/g,'-')}.geojson`, JSON.stringify(gj, null, 2), "application/geo+json");
}
function exportGPX(){
  const header = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="LeafletTrack" xmlns="http://www.topografix.com/GPX/1/1">\n<trk><name>Recorded Track</name><trkseg>\n`;
  const seg = trackPoints.map(p=>{
    const iso = new Date(p.time).toISOString();
    return `  <trkpt lat="${p.lat}" lon="${p.lng}"><time>${iso}</time></trkpt>`;
  }).join("\n");
  const footer = `\n</trkseg></trk>\n</gpx>`;
  downloadFile(`track_${new Date().toISOString().replace(/[:.]/g,'-')}.gpx`, header+seg+footer, "application/gpx+xml");
}

/* é€šçŸ¥ï¼ˆWebAudio + ãƒã‚¤ãƒ–ï¼‰ */
let audioCtx = null;
function initAudioIfNeeded() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
  } catch (_) {}
}
function playChime() {
  if (!audioCtx) return;
  const now = audioCtx.currentTime;
  const master = audioCtx.createGain();
  master.gain.value = 0.22;
  master.connect(audioCtx.destination);
  function beep(freq, t0, dur) {
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(freq, now + t0);
    g.gain.setValueAtTime(0.0001, now + t0);
    g.gain.exponentialRampToValueAtTime(0.25, now + t0 + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + t0 + dur);
    osc.connect(g).connect(master);
    osc.start(now + t0);
    osc.stop(now + t0 + dur + 0.05);
  }
  beep(880, 0.00, 0.20);
  beep(1318.51, 0.18, 0.22);
}
function vibratePattern() {
  if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
}
function notifyArrivalOnce() {
  const soundOn = $('soundEnable')?.checked ?? true;
  const vibeOn  = $('vibeEnable')?.checked ?? true;
  if (vibeOn) vibratePattern();
  if (soundOn) { initAudioIfNeeded(); playChime(); }
}
$('testNotifyBtn').addEventListener('click', ()=>{ initAudioIfNeeded(); notifyArrivalOnce(); });

function drawTarget(idx){
  if(idx<0 || idx>=targets.length) return;
  const t = targets[idx];
  if(destMarker){ destMarker.remove(); destMarker=null; }
  if(destCircle){ destCircle.remove(); destCircle=null; }

  destMarker = createEmojiMarker(t.latLng, 'ğŸ')
    .addTo(map)
    .bindTooltip(t.labelHtml, {permanent:false});

  destCircle = L.circle(t.latLng, {radius: t.radius, color:'#0077cc', opacity:0.7, fillColor:'#00aaff', fillOpacity:0.15}).addTo(map);
  map.panTo(t.latLng);

  $('progress').innerHTML = `ç›®çš„åœ° ${idx+1}/${targets.length}ï¼š${t.labelHtml}`;
  setStatus(`æ¬¡ã®ç›®çš„åœ°: ${t.labelText}ï¼ˆåŠå¾„ ${t.radius}mï¼‰ / å®Ÿç§»å‹•è·é›¢: ${fmtMeters(trackDistance)}`);
  redrawTraveled();
}

async function preloadImages(list){
  for(const t of list){
    if(t.img && !preloaded.has(t.img)){
      const img = new Image();
      const p = new Promise(res=>{ img.onload=res; img.onerror=res; });
      img.src = t.img;
      await Promise.race([p, sleep(2000)]);
      preloaded.set(t.img, true);
    }
  }
}

function showArrival(t){
  notifyArrivalOnce();
  $('imgTitle').innerHTML = `åˆ°ç€: ${t.labelHtml}`;
  const imgEl = $('showImg');
  if(t.img){ imgEl.src = t.img; imgEl.style.display='block'; }
  else { imgEl.removeAttribute('src'); imgEl.style.display='none'; }
  $('imgModal').style.display = 'flex';
}
$('closeModal').addEventListener('click', ()=>{ $('imgModal').style.display='none'; goNext(); });

function goNext(){
  arrivalLock=false;
  currentIdx++;
  if(currentIdx >= targets.length){
    setStatus(`å…¨ç›®çš„åœ°ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼ / å®Ÿç§»å‹•è·é›¢: ${fmtMeters(trackDistance)}`);
    $('startBtn').disabled = true;
    $('skipBtn').disabled = true;
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
    redrawTraveled();
    return;
  }
  drawTarget(currentIdx);
}

function startWatch(){
  if(!('geolocation' in navigator)){ alert('ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'); return; }
  const opts = { enableHighAccuracy:true, maximumAge:5000, timeout:20000 };
  watchId = navigator.geolocation.watchPosition(pos=>{
    const { latitude, longitude, accuracy } = pos.coords;
    const here = { lat: latitude, lng: longitude };

    if(trackRecording){
      appendTrackPoint(here.lat, here.lng, pos.timestamp || Date.now());
    }

    if(!meMarker){
      meMarker = createEmojiMarker(here, 'ğŸ“').addTo(map).bindTooltip('ç¾åœ¨åœ°',{permanent:false});
      meCircle = L.circle(here, { radius: Math.max(10, accuracy||10), color:'#888', opacity:.6, fillColor:'#999', fillOpacity:.1 }).addTo(map);
      map.panTo(here);
    }else{
      meMarker.setLatLng(here);
      meCircle.setLatLng(here).setRadius(Math.max(10, accuracy||10));
    }

    if(currentIdx<targets.length){
      const t=targets[currentIdx];
      const d = haversine(here, t.latLng);
      setStatus(`ç¾åœ¨åœ°=(${latitude.toFixed(5)}, ${longitude.toFixed(5)}) Â±${Math.round(accuracy||0)}m / ã€Œ${t.labelText}ã€ã¾ã§ç´„ ${Math.round(d)}m / å®Ÿç§»å‹•è·é›¢: ${fmtMeters(trackDistance)}`);
      if(!arrivalLock && d <= t.radius){
        arrivalLock=true;
        showArrival(t);
      }
    }
  }, err=>{ alert('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼: ' + err.message); }, opts);
}

/* ================== UIã‚¤ãƒ™ãƒ³ãƒˆ ================== */
function resetAll(){
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  targets=[]; currentIdx=0; arrivalLock=false; preloaded.clear();
  if(destMarker){ destMarker.remove(); destMarker=null; }
  if(destCircle){ destCircle.remove(); destCircle=null; }
  if(meMarker){ meMarker.remove(); meMarker=null; }
  if(meCircle){ meCircle.remove(); meCircle=null; }
  if(routeLine){ routeLine.remove(); routeLine=null; }
  if(traveledLine){ traveledLine.remove(); traveledLine=null; }
  clearTrack();
  $('progress').textContent='æœªèª­è¾¼';
  setStatus('-');
  $('startBtn').disabled=true;
  $('skipBtn').disabled=true;
  $('drawRouteBtn').disabled=true;
  $('fitRouteBtn').disabled=true;
  $('toggleTrackBtn').disabled=true;
  $('clearTrackBtn').disabled=true;
  $('exportGpxBtn').disabled=true;
  $('exportGeoBtn').disabled=true;
}
$('resetBtn').addEventListener('click', resetAll);
$('skipBtn').addEventListener('click', ()=>{ $('imgModal').style.display='none'; goNext(); });

function afterListLoaded(){
  drawTarget(0);
  drawRoute();
  redrawTraveled();
  $('startBtn').disabled=false;
  $('skipBtn').disabled=false;
  $('drawRouteBtn').disabled=false;
  $('fitRouteBtn').disabled=false;
  $('toggleTrackBtn').disabled=false;
  $('clearTrackBtn').disabled=false;
  $('exportGpxBtn').disabled=false;
  $('exportGeoBtn').disabled=false;
}

$('loadArrayBtn').addEventListener('click', async ()=>{
  resetAll();
  targets = fromArray(DESTS);
  await preloadImages(targets);
  currentIdx = 0;
  afterListLoaded();
  setStatus(`å†…è”µãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${targets.length}ä»¶ï¼‰ã€‚ã€Œè¿½è·¡é–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆã€‚`);
});

$('loadCsvBtn').addEventListener('click', async ()=>{
  resetAll();
  const items = parseCsvToTargets($('csvInput').value);
  if(items.length===0){ alert('æœ‰åŠ¹ãªè¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  targets = items;
  await preloadImages(targets);
  currentIdx = 0;
  afterListLoaded();
  setStatus(`CSVèª­è¾¼ å®Œäº†ï¼ˆ${targets.length}ä»¶ï¼‰ã€‚ã€Œè¿½è·¡é–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆã€‚`);
});

$('saveCsvBtn').addEventListener('click', ()=>{
  localStorage.setItem('leaflet_arrival_csv', $('csvInput').value);
  setStatus('CSVã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ãƒ»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ï¼‰ã€‚');
});
$('restoreCsvBtn').addEventListener('click', ()=>{
  $('csvInput').value = localStorage.getItem('leaflet_arrival_csv') || '';
  setStatus('CSVã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã€ŒCSVèª­è¾¼ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
});

/* å¤–éƒ¨CSV URL */
$('loadUrlBtn').addEventListener('click', async ()=>{
  const url = $('csvUrl').value.trim();
  if(!url){ alert('CSVã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  try{
    setStatus('CSVå–å¾—ä¸­â€¦'); resetAll();
    const text = await fetchCsvText(url);
    const items = parseCsvToTargets(text);
    if(items.length === 0){ alert('CSVã®å½¢å¼ã‚’è§£é‡ˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\næœŸå¾…: label,lat,lng ã¾ãŸã¯ name,address,lat,lng'); return; }
    targets = items;
    await preloadImages(targets);
    currentIdx = 0;
    afterListLoaded();
    setStatus(`URLã‹ã‚‰èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆ${targets.length}ä»¶ï¼‰ã€‚ã€Œè¿½è·¡é–‹å§‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆã€‚`);
  }catch(e){
    alert(`CSVå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${e.message}\nï¼ˆCORSã‚„URLèª¤ã‚Šã®å¯èƒ½æ€§ï¼‰`);
    setStatus('CSVå–å¾—ã«å¤±æ•—ï¼ˆCORS/URL/é€šä¿¡ï¼‰');
  }
});
$('saveUrlBtn').addEventListener('click', ()=>{
  localStorage.setItem('arrival_csv_url', $('csvUrl').value.trim());
  setStatus('URLã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ã¿ï¼‰');
});
$('restoreUrlBtn').addEventListener('click', ()=>{
  $('csvUrl').value = localStorage.getItem('arrival_csv_url') || '';
  setStatus('URLã‚’å¾©å…ƒã—ã¾ã—ãŸ');
});

/* ãƒ«ãƒ¼ãƒˆç·šãƒœã‚¿ãƒ³ */
$('drawRouteBtn').addEventListener('click', ()=>{ if(targets.length){ drawRoute(); redrawTraveled(); }});
$('fitRouteBtn').addEventListener('click', ()=>{ if(targets.length){ fitRouteBounds(); }});

/* è»Œè·¡ãƒœã‚¿ãƒ³ */
$('toggleTrackBtn').addEventListener('click', toggleTrack);
$('clearTrackBtn').addEventListener('click', clearTrack);
$('exportGpxBtn').addEventListener('click', exportGPX);
$('exportGeoBtn').addEventListener('click', exportGeoJSON);

$('startBtn').addEventListener('click', ()=>{
  if(targets.length===0){ alert('å…ˆã«ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
  initAudioIfNeeded(); // iOSå¯¾ç­–ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§AudioContextèµ·å‹•
  if(watchId) navigator.geolocation.clearWatch(watchId);
  arrivalLock=false;
  startWatch();
});

/* ================== ãƒãƒƒãƒ—åˆæœŸåŒ– ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // åˆæœŸä¸­å¿ƒã¯æ»‹è³€çœŒåºä»˜è¿‘
  map = L.map('map', { zoomControl:true }).setView([35.0045,135.8686], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
});
</script>
</body>
</html>
